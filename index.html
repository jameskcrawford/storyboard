<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storyboard</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Short film storyboard tool">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Storyboard">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 20px;
        }

        .header {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            opacity: 0.7;
        }

        #addShotBtn,
        #savePngBtn,
        #saveJsonBtn,
        #loadFileBtn,
        #settingsBtn {
            background-color: #333;
            color: #fff;
        }

        .auto-saved {
            color: #00C853;
            font-size: 14px;
            margin-left: auto;
        }

        .shot-counter {
            color: #999;
            font-size: 14px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }

        .shot-counter .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .shot-counter .total {
            color: #fff;
            font-weight: 500;
        }

        .shot-counter .approved {
            color: #00C853;
        }

        .shot-counter .in-progress {
            color: #1E90FF;
        }


        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #333;
        }

        th {
            background-color: #1a1a1a;
            padding: 15px;
            text-align: left;
            border: 1px solid #333;
            font-weight: 500;
        }

        td {
            border: 1px solid #333;
            padding: 15px;
            vertical-align: top;
            height: 100%;
        }

        /* Text input cells need special handling for flexbox */
        td:nth-child(2),
        td:nth-child(3),
        td:nth-child(4) {
            padding: 8px;
        }

        .shot-number {
            width: 80px;
            text-align: center;
            font-weight: 500;
        }

        .shot-number input {
            width: 100%;
            background-color: #000;
            color: #fff;
            border: none;
            text-align: center;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            outline: none;
        }

        .shot-number input:focus {
            background-color: #1a1a1a;
        }

        /* Textarea container with buttons */
        .textarea-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .textarea-buttons {
            display: flex;
            gap: 3px;
            justify-content: flex-end;
            padding: 4px;
            margin-top: auto;
        }

        .textarea-buttons button {
            background-color: transparent;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            padding: 0;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #666;
        }

        /* Mic button is red */
        .textarea-buttons .mic-btn {
            color: #DC143C;
        }

        .textarea-buttons button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .textarea-buttons .mic-btn:hover {
            color: #FF1744;
        }

        .textarea-buttons button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .textarea-buttons button.recording {
            background-color: rgba(244, 67, 54, 0.3);
            color: #FF1744;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        textarea {
            width: 100%;
            background-color: #000;
            color: #fff;
            border: none;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            padding: 8px;
            flex: 1;
        }

        textarea:focus {
            background-color: #1a1a1a;
        }

        .reference-images-cell {
            min-width: 400px;
            max-width: 600px;
        }

        .images-container {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .images-container::-webkit-scrollbar {
            height: 8px;
        }

        .images-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }

        .images-container::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        .images-container::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        .image-item {
            position: relative;
            cursor: move;
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 8px;
            background-color: #1a1a1a;
            flex-shrink: 0;
        }

        .image-item.dragging {
            opacity: 0.5;
            border-color: #1E90FF;
        }

        .image-item.drag-over {
            border-color: #00C853;
        }

        .image-preview {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            display: block;
        }

        .image-caption {
            width: 150px;
            margin-top: 8px;
            background-color: #000;
            color: #fff;
            border: 1px solid #333;
            padding: 6px;
            font-size: 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        .image-caption:focus {
            border-color: #1E90FF;
            outline: none;
        }

        .remove-image {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #ff0000;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-image-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .add-image-area {
            width: 150px;
            height: 150px;
            border: 2px dashed #666;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-image-area:hover {
            border-color: #1E90FF;
            background-color: #1a1a1a;
        }

        .add-image-area .plus {
            font-size: 36px;
            color: #666;
        }

        .add-image-area .hint {
            font-size: 11px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        .paste-input {
            width: 150px;
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            padding: 8px;
            font-size: 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        .paste-input:focus {
            border-color: #1E90FF;
            outline: none;
        }

        .paste-input::placeholder {
            color: #666;
        }

        .status-select {
            width: 100%;
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .status-select:focus {
            border-color: #1E90FF;
            outline: none;
        }

        .status-select option {
            background-color: #1a1a1a;
            color: #fff;
        }

        .status-notes {
            width: 100%;
            background-color: #000;
            color: #fff;
            border: none;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            font-size: 13px;
            outline: none;
        }

        .status-notes:focus {
            background-color: #1a1a1a;
        }

        .actions-cell {
            min-width: 70px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
        }

        .action-buttons button {
            background-color: transparent;
            color: #999;
            font-size: 20px;
            padding: 6px;
            border: none;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .action-buttons button:hover {
            color: #fff;
            background-color: #333;
            border-radius: 4px;
        }

        .drag-handle {
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle:hover {
            color: #1E90FF;
        }

        .duplicate-row:hover {
            color: #00C853;
        }

        .export-shot:hover {
            color: #1E90FF;
        }

        .delete-row:hover {
            color: #ff0000;
        }

        .lock-toggle:hover {
            color: #FF9800;
        }

        .lock-toggle[data-locked="true"] {
            color: #F44336;
        }

        .lock-toggle[data-locked="true"]:hover {
            color: #ff5555;
        }

        tr.dragging {
            opacity: 0.5;
            background-color: #1a1a1a;
        }

        tr.drag-over {
            border-top: 3px solid #1E90FF;
        }

        tr.locked {
            opacity: 0.6;
            background-color: #1a1a1a;
        }

        tr.locked textarea,
        tr.locked input,
        tr.locked select {
            pointer-events: none;
            background-color: #0a0a0a !important;
        }

        tr.locked .drag-handle,
        tr.locked .duplicate-row,
        tr.locked .delete-row {
            pointer-events: none;
            opacity: 0.3;
        }

        input[type="file"] {
            display: none;
        }

        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-image {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ff0000;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .fullscreen-close:hover {
            background-color: #cc0000;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background-color: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
        }

        .settings-content h2 {
            margin: 0 0 20px 0;
            color: #1E90FF;
            font-size: 24px;
        }

        .settings-content label {
            display: block;
            margin-bottom: 8px;
            color: #fff;
            font-size: 14px;
        }

        .settings-content input[type="password"],
        .settings-content input[type="text"] {
            width: 100%;
            padding: 10px;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .settings-content .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .settings-content .button-group button {
            flex: 1;
        }

        .settings-content .save-btn {
            background-color: #1E90FF;
            color: #fff;
        }

        .settings-content .clear-btn {
            background-color: #F44336;
            color: #fff;
        }

        .settings-content .cancel-btn {
            background-color: #333;
            color: #fff;
        }

        .settings-content .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
            line-height: 1.5;
        }

        .settings-content .info-text a {
            color: #1E90FF;
            text-decoration: none;
        }

        .settings-content .info-text a:hover {
            text-decoration: underline;
        }

        /* Mobile - Portrait */
        @media (max-width: 768px) and (orientation: portrait) {
            body {
                padding: 8px;
            }

            .header {
                gap: 6px;
                flex-direction: column;
                align-items: stretch;
            }

            .header button {
                padding: 12px 16px;
                font-size: 14px;
            }

            .shot-counter {
                justify-content: flex-start;
                gap: 10px;
                font-size: 13px;
            }

            .auto-saved {
                margin-left: 0;
            }

            th, td {
                padding: 8px;
                font-size: 12px;
            }

            .shot-number {
                width: 50px;
            }

            textarea {
                min-height: 100px;
                font-size: 14px;
                line-height: 1.4;
                padding: 6px;
            }

            textarea::placeholder {
                font-size: 13px;
                line-height: 1.3;
            }

            /* Stack mic and enhance buttons vertically in portrait */
            .textarea-buttons {
                flex-direction: row;
                gap: 4px;
            }

            .textarea-buttons button {
                width: 22px;
                height: 22px;
                font-size: 12px;
            }

            .reference-images-cell {
                min-width: 250px;
                max-width: 300px;
            }

            .image-preview,
            .add-image-area {
                width: 100px;
                height: 100px;
            }

            .image-caption,
            .paste-input {
                width: 100px;
                font-size: 11px;
            }

            .action-buttons button {
                width: 40px;
                height: 40px;
                font-size: 22px;
            }
        }

        /* Mobile - Landscape (Your primary use case) */
        @media (max-width: 926px) and (orientation: landscape) {
            body {
                padding: 2px;
            }

            .header {
                gap: 3px;
                margin-bottom: 4px;
            }

            .header button {
                padding: 4px 6px;
                font-size: 9px;
            }

            .shot-counter {
                gap: 4px;
                font-size: 8px;
            }

            .shot-counter .stat {
                white-space: nowrap;
            }

            .auto-saved {
                font-size: 8px;
            }

            th {
                padding: 3px;
                font-size: 9px;
                white-space: nowrap;
            }

            td {
                padding: 3px;
                font-size: 9px;
            }

            .shot-number {
                width: 32px;
                min-width: 32px;
                max-width: 32px;
            }

            .shot-number input {
                font-size: 9px;
                padding: 1px;
            }

            /* Make textareas fit and show full placeholder */
            textarea {
                min-height: 85px;
                max-height: 110px;
                font-size: 9px;
                padding: 3px;
                width: 100%;
                line-height: 1.3;
                overflow-y: auto;
            }

            textarea::placeholder {
                font-size: 8px;
                line-height: 1.3;
                white-space: pre-wrap;
            }

            .status-select {
                font-size: 8px;
                padding: 2px;
            }

            .status-notes {
                min-height: 25px;
                font-size: 8px;
            }

            /* Fixed table layout to control widths */
            table {
                font-size: 9px;
                table-layout: fixed;
                width: 100%;
            }

            /* Precise column widths for landscape fit */
            th:nth-child(1) { width: 32px; } /* Shot # */
            th:nth-child(2) { width: 17%; }  /* Visual Action */
            th:nth-child(3) { width: 17%; }  /* Audio */
            th:nth-child(4) { width: 17%; }  /* Shot Specs */
            th:nth-child(5) { width: 20%; }  /* Reference Images */
            th:nth-child(6) { width: 11%; }  /* Status */
            th:nth-child(7) { width: 35px; } /* Actions */

            .reference-images-cell {
                min-width: unset;
                max-width: unset;
            }

            .images-container {
                gap: 6px;
            }

            .image-preview,
            .add-image-area {
                width: 60px;
                height: 60px;
            }

            .image-caption,
            .paste-input {
                width: 60px;
                font-size: 7px;
            }

            .add-image-area .plus {
                font-size: 20px;
            }

            .add-image-area .hint {
                font-size: 7px;
            }

            .action-buttons {
                gap: 1px;
            }

            .action-buttons button {
                width: 26px;
                height: 26px;
                font-size: 14px;
                padding: 2px;
            }

            .actions-cell {
                min-width: 35px;
                max-width: 35px;
            }

            /* Hide lock button to save space */
            .lock-toggle {
                display: none;
            }
        }

        /* Tablet and smaller desktop */
        @media (min-width: 769px) and (max-width: 1024px) {
            .reference-images-cell {
                min-width: 350px;
                max-width: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="addShotBtn">+ Add Shot</button>
        <button id="savePngBtn">📄 Save Project as PDF</button>
        <button id="saveJsonBtn">💾 Save Data (JSON)</button>
        <button id="loadFileBtn">📁 Load from File</button>
        <button id="settingsBtn">⚙️ Settings</button>
        <input type="file" id="fileInput" accept=".json">
        <div class="shot-counter" id="shotCounter">
            <div class="stat total"><span id="totalShots">0</span> shots</div>
            <div class="stat approved"><span id="approvedShots">0</span> approved</div>
            <div class="stat in-progress"><span id="inProgressShots">0</span> in progress</div>
        </div>
        <div class="auto-saved" id="autoSavedIndicator">Auto-saved ✓</div>
    </div>

    <div class="table-container">
        <table id="storyboardTable">
            <thead>
                <tr>
                    <th>Shot #</th>
                    <th>Visual Action</th>
                    <th>Audio</th>
                    <th>Shot Specs</th>
                    <th>Reference Images</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <button class="fullscreen-close" id="fullscreenClose">×</button>
        <img class="fullscreen-image" id="fullscreenImage" src="" alt="Fullscreen view">
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2>Settings</h2>
            <label for="apiKeyInput">OpenAI API Key</label>
            <input type="password" id="apiKeyInput" placeholder="sk-...">
            <p class="info-text">
                Your API key is stored locally on your device only and is never shared.
                It's only used when you click the ✨ enhance button.
                <br><br>
                Don't have an API key? <a href="https://platform.openai.com/api-keys" target="_blank">Get one here</a>
            </p>
            <div class="button-group">
                <button class="save-btn" id="saveApiKey">Save</button>
                <button class="clear-btn" id="clearApiKey">Clear</button>
                <button class="cancel-btn" id="cancelSettings">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let autoSaveTimeout;

        // Initialize with 5 rows
        function init() {
            const savedData = localStorage.getItem('storyboardData');
            if (savedData) {
                loadData(JSON.parse(savedData));
            } else {
                for (let i = 0; i < 5; i++) {
                    addRow();
                }
            }
            updateShotCounter();
        }

        // Get next shot number
        function getNextShotNumber() {
            const rows = document.querySelectorAll('#tableBody tr');
            if (rows.length === 0) {
                return '001';
            }

            const lastRow = rows[rows.length - 1];
            const lastShotInput = lastRow.querySelector('.shot-number-input');
            if (lastShotInput) {
                const lastNum = parseInt(lastShotInput.value) || rows.length;
                return String(lastNum + 1).padStart(3, '0');
            }

            return String(rows.length + 1).padStart(3, '0');
        }

        // Add a new row
        function addRow(data = null) {
            const tbody = document.getElementById('tableBody');
            const row = document.createElement('tr');

            const shotNum = data?.shotNumber || getNextShotNumber();

            row.innerHTML = `
                <td class="shot-number"><input type="text" class="shot-number-input" value="${shotNum}"></td>
                <td>
                    <div class="textarea-container">
                        <textarea class="visual-action" placeholder="What do we see? What's happening?">${data?.visualAction || data?.shotDescription || ''}</textarea>
                        <div class="textarea-buttons">
                            <button class="mic-btn" title="Voice Input">●</button>
                            <button class="enhance-btn" title="Enhance with AI">✨</button>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="textarea-container">
                        <textarea class="audio" placeholder="What do we hear? Dialogue? Music? Sounds?">${data?.audio || data?.dialogue || ''}</textarea>
                        <div class="textarea-buttons">
                            <button class="mic-btn" title="Voice Input">●</button>
                            <button class="enhance-btn" title="Enhance with AI">✨</button>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="textarea-container">
                        <textarea class="shot-specs" placeholder="How do we film this? (e.g., CU, low angle, pan left)">${data?.shotSpecs || data?.subjects || ''}</textarea>
                        <div class="textarea-buttons">
                            <button class="mic-btn" title="Voice Input">●</button>
                            <button class="enhance-btn" title="Enhance with AI">✨</button>
                        </div>
                    </div>
                </td>
                <td class="reference-images-cell">
                    <div class="images-container"></div>
                </td>
                <td>
                    <select class="status-select">
                        <option value="planned" ${(data?.status || 'planned') === 'planned' ? 'selected' : ''}>Planned</option>
                        <option value="in-progress" ${data?.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="shot" ${data?.status === 'shot' ? 'selected' : ''}>Shot</option>
                        <option value="approved" ${data?.status === 'approved' ? 'selected' : ''}>Approved</option>
                        <option value="needs-reshoot" ${data?.status === 'needs-reshoot' ? 'selected' : ''}>Needs Reshoot</option>
                    </select>
                    <textarea class="status-notes" placeholder="Add notes...">${data?.notes || ''}</textarea>
                </td>
                <td class="actions-cell">
                    <div class="action-buttons">
                        <button class="drag-handle" title="Drag to Reorder">☰</button>
                        <button class="duplicate-row" title="Duplicate Shot">⧉</button>
                        <button class="lock-toggle" title="${data?.locked ? 'Unlock Shot' : 'Lock Shot'}" data-locked="${data?.locked ? 'true' : 'false'}">${data?.locked ? '🔒' : '🔓'}</button>
                        <button class="export-shot" title="Export Shot as PNG">⎙</button>
                        <button class="delete-row" title="Delete Shot">×</button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);

            // Apply locked class if needed
            if (data?.locked) {
                row.classList.add('locked');
            }

            // Add event listeners for text areas, shot number input, status select, and status notes
            row.querySelectorAll('textarea, .shot-number-input, .status-select').forEach(input => {
                input.addEventListener('input', triggerAutoSave);
                if (input.tagName === 'SELECT') {
                    input.addEventListener('change', () => {
                        triggerAutoSave();
                        updateShotCounter();
                    });
                }
            });

            // Drag and drop functionality
            const dragHandle = row.querySelector('.drag-handle');
            let touchStartY = 0;
            let touchCurrentY = 0;
            let isDragging = false;

            // Desktop drag and drop
            dragHandle.addEventListener('mousedown', () => {
                row.setAttribute('draggable', 'true');
            });

            dragHandle.addEventListener('mouseup', () => {
                row.setAttribute('draggable', 'false');
            });

            // Mobile touch-based drag and drop
            dragHandle.addEventListener('touchstart', (e) => {
                if (row.classList.contains('locked')) return;

                touchStartY = e.touches[0].clientY;
                isDragging = true;
                row.style.opacity = '0.5';
                row.style.position = 'relative';
                e.preventDefault();
            });

            dragHandle.addEventListener('touchmove', (e) => {
                if (!isDragging) return;

                touchCurrentY = e.touches[0].clientY;
                const deltaY = touchCurrentY - touchStartY;
                row.style.transform = `translateY(${deltaY}px)`;

                // Find which row we're over
                const allRows = [...document.querySelectorAll('#tableBody tr')];
                const rowHeight = row.offsetHeight;
                const currentIndex = allRows.indexOf(row);
                const moveByRows = Math.round(deltaY / rowHeight);
                const targetIndex = currentIndex + moveByRows;

                // Remove all drag-over classes
                allRows.forEach(r => r.classList.remove('drag-over'));

                // Add drag-over to target row
                if (targetIndex >= 0 && targetIndex < allRows.length && targetIndex !== currentIndex) {
                    allRows[targetIndex].classList.add('drag-over');
                }

                e.preventDefault();
            });

            dragHandle.addEventListener('touchend', (e) => {
                if (!isDragging) return;

                isDragging = false;
                row.style.opacity = '';
                row.style.transform = '';
                row.style.position = '';

                const allRows = [...document.querySelectorAll('#tableBody tr')];
                const rowHeight = row.offsetHeight;
                const currentIndex = allRows.indexOf(row);
                const deltaY = touchCurrentY - touchStartY;
                const moveByRows = Math.round(deltaY / rowHeight);
                const targetIndex = currentIndex + moveByRows;

                // Actually move the row
                if (targetIndex >= 0 && targetIndex < allRows.length && targetIndex !== currentIndex) {
                    const targetRow = allRows[targetIndex];
                    if (targetIndex > currentIndex) {
                        targetRow.after(row);
                    } else {
                        targetRow.before(row);
                    }
                    renumberShots();
                    triggerAutoSave();
                }

                // Remove all drag-over classes
                allRows.forEach(r => r.classList.remove('drag-over'));

                e.preventDefault();
            });

            row.addEventListener('dragstart', (e) => {
                if (row.classList.contains('locked')) {
                    e.preventDefault();
                    return;
                }
                row.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            row.addEventListener('dragend', () => {
                row.classList.remove('dragging');
                row.setAttribute('draggable', 'false');
                document.querySelectorAll('#tableBody tr').forEach(r => {
                    r.classList.remove('drag-over');
                });
                renumberShots();
                triggerAutoSave();
            });

            row.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingRow = document.querySelector('#tableBody tr.dragging');
                if (draggingRow && draggingRow !== row) {
                    row.classList.add('drag-over');
                }
            });

            row.addEventListener('dragleave', () => {
                row.classList.remove('drag-over');
            });

            row.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggingRow = document.querySelector('#tableBody tr.dragging');
                if (draggingRow && draggingRow !== row) {
                    const allRows = [...document.querySelectorAll('#tableBody tr')];
                    const draggingIndex = allRows.indexOf(draggingRow);
                    const targetIndex = allRows.indexOf(row);

                    if (draggingIndex < targetIndex) {
                        row.after(draggingRow);
                    } else {
                        row.before(draggingRow);
                    }
                }
                row.classList.remove('drag-over');
            });

            // Lock/unlock functionality
            const lockToggle = row.querySelector('.lock-toggle');
            lockToggle.addEventListener('click', () => {
                const isLocked = lockToggle.getAttribute('data-locked') === 'true';

                if (isLocked) {
                    lockToggle.setAttribute('data-locked', 'false');
                    lockToggle.textContent = '🔓';
                    lockToggle.title = 'Lock Shot';
                    row.classList.remove('locked');
                } else {
                    lockToggle.setAttribute('data-locked', 'true');
                    lockToggle.textContent = '🔒';
                    lockToggle.title = 'Unlock Shot';
                    row.classList.add('locked');
                }
                triggerAutoSave();
            });

            // Duplicate row functionality
            row.querySelector('.duplicate-row').addEventListener('click', () => {
                const rowData = getRowData(row);
                const newRow = addRow(rowData);
                row.after(newRow);
                renumberShots();
                updateShotCounter();
                triggerAutoSave();
            });

            // Export shot functionality
            row.querySelector('.export-shot').addEventListener('click', () => {
                exportSingleShot(row);
            });

            // Delete row functionality
            row.querySelector('.delete-row').addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this shot?')) {
                    row.remove();
                    renumberShots();
                    updateShotCounter();
                    triggerAutoSave();
                }
            });

            // Setup microphone and enhance buttons
            const micButtons = row.querySelectorAll('.mic-btn');
            const enhanceButtons = row.querySelectorAll('.enhance-btn');

            micButtons.forEach(micBtn => {
                micBtn.addEventListener('click', () => {
                    const textarea = micBtn.closest('.textarea-container').querySelector('textarea');
                    startVoiceInput(textarea, micBtn);
                });
            });

            enhanceButtons.forEach(enhanceBtn => {
                enhanceBtn.addEventListener('click', () => {
                    const textarea = enhanceBtn.closest('.textarea-container').querySelector('textarea');
                    enhanceTextWithAI(textarea);
                });
            });

            // Setup image area
            const imagesContainer = row.querySelector('.images-container');
            setupImageArea(imagesContainer, data?.images || []);

            return row;
        }

        // Renumber shots after deletion
        function renumberShots() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach((row, index) => {
                const shotNumberInput = row.querySelector('.shot-number-input');
                if (shotNumberInput) {
                    shotNumberInput.value = String(index + 1).padStart(3, '0');
                }
            });
        }

        // Get data from a single row
        function getRowData(row) {
            const shotNumber = row.querySelector('.shot-number-input').value;
            const visualAction = row.querySelector('.visual-action').value;
            const audio = row.querySelector('.audio').value;
            const shotSpecs = row.querySelector('.shot-specs').value;
            const status = row.querySelector('.status-select').value;
            const notes = row.querySelector('.status-notes').value;
            const locked = row.querySelector('.lock-toggle').getAttribute('data-locked') === 'true';

            const images = [];
            row.querySelectorAll('.image-item').forEach(imageItem => {
                const img = imageItem.querySelector('.image-preview');
                const caption = imageItem.querySelector('.image-caption').value;
                images.push({
                    src: img.src,
                    caption: caption
                });
            });

            return {
                shotNumber,
                visualAction,
                audio,
                shotSpecs,
                status,
                notes,
                locked,
                images
            };
        }

        // Update shot counter
        function updateShotCounter() {
            const rows = document.querySelectorAll('#tableBody tr');
            const total = rows.length;
            let approved = 0;
            let inProgress = 0;

            rows.forEach(row => {
                const status = row.querySelector('.status-select').value;
                if (status === 'approved') {
                    approved++;
                } else if (status === 'in-progress' || status === 'shot' || status === 'needs-reshoot') {
                    inProgress++;
                }
            });

            document.getElementById('totalShots').textContent = total;
            document.getElementById('approvedShots').textContent = approved;
            document.getElementById('inProgressShots').textContent = inProgress;
        }

        // Setup image area with paste and click functionality
        function setupImageArea(container, existingImages = []) {
            // Create add image button first
            updateAddButton(container);

            // Add existing images
            existingImages.forEach(imageData => {
                addImageToContainer(container, imageData.src, imageData.caption);
            });
        }

        // Add image to container
        function addImageToContainer(container, imageSrc, caption = '') {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.draggable = true;

            imageItem.innerHTML = `
                <button class="remove-image">×</button>
                <img src="${imageSrc}" class="image-preview">
                <input type="text" class="image-caption" placeholder="Add caption..." value="${caption}">
            `;

            // Insert before the add-image-wrapper
            const wrapper = container.querySelector('.add-image-wrapper');
            if (wrapper) {
                container.insertBefore(imageItem, wrapper);
            } else {
                container.appendChild(imageItem);
            }

            // Add drag and drop functionality
            setupDragAndDrop(imageItem, container);

            // Remove image functionality
            imageItem.querySelector('.remove-image').addEventListener('click', () => {
                imageItem.remove();
                triggerAutoSave();
            });

            // Caption input
            imageItem.querySelector('.image-caption').addEventListener('input', triggerAutoSave);

            // Double-click to fullscreen
            const imgElement = imageItem.querySelector('.image-preview');
            imgElement.addEventListener('dblclick', () => {
                showFullscreen(imageSrc);
            });
        }

        // Show image in fullscreen
        function showFullscreen(imageSrc) {
            const overlay = document.getElementById('fullscreenOverlay');
            const fullscreenImg = document.getElementById('fullscreenImage');
            fullscreenImg.src = imageSrc;
            overlay.classList.add('active');
        }

        // Close fullscreen
        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('active');
        }

        // Update add button
        function updateAddButton(container) {
            let wrapper = container.querySelector('.add-image-wrapper');
            if (!wrapper) {
                wrapper = document.createElement('div');
                wrapper.className = 'add-image-wrapper';

                // Create upload button
                const addButton = document.createElement('div');
                addButton.className = 'add-image-area';
                addButton.innerHTML = `
                    <div class="plus">+</div>
                    <div class="hint">Upload Image</div>
                `;

                addButton.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.multiple = true;
                    input.onchange = (e) => {
                        const files = Array.from(e.target.files);
                        files.forEach(file => {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                addImageToContainer(container, event.target.result);
                                triggerAutoSave();
                            };
                            reader.readAsDataURL(file);
                        });
                    };
                    input.click();
                });

                // Create paste input
                const pasteInput = document.createElement('input');
                pasteInput.type = 'text';
                pasteInput.className = 'paste-input';
                pasteInput.placeholder = 'Paste image here...';

                pasteInput.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const items = e.clipboardData.items;
                    for (let item of items) {
                        if (item.type.indexOf('image') !== -1) {
                            const file = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                addImageToContainer(container, event.target.result);
                                pasteInput.value = '';
                                triggerAutoSave();
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                });

                wrapper.appendChild(addButton);
                wrapper.appendChild(pasteInput);
                container.appendChild(wrapper);
            }
        }

        // Drag and drop functionality
        function setupDragAndDrop(item, container) {
            item.addEventListener('dragstart', (e) => {
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                container.querySelectorAll('.image-item').forEach(i => {
                    i.classList.remove('drag-over');
                });
                triggerAutoSave();
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingItem = container.querySelector('.dragging');
                if (draggingItem && draggingItem !== item) {
                    item.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', () => {
                item.classList.remove('drag-over');
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggingItem = container.querySelector('.dragging');
                if (draggingItem && draggingItem !== item) {
                    const allItems = [...container.querySelectorAll('.image-item')];
                    const draggingIndex = allItems.indexOf(draggingItem);
                    const targetIndex = allItems.indexOf(item);

                    if (draggingIndex < targetIndex) {
                        item.after(draggingItem);
                    } else {
                        item.before(draggingItem);
                    }
                }
                item.classList.remove('drag-over');
            });
        }

        // Auto-save functionality
        function triggerAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveToLocalStorage();
                showAutoSavedIndicator();
            }, 500);
        }

        function saveToLocalStorage() {
            const data = collectData();
            localStorage.setItem('storyboardData', JSON.stringify(data));
        }

        function showAutoSavedIndicator() {
            const indicator = document.getElementById('autoSavedIndicator');
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0.5';
            }, 1000);
        }

        // Collect all data from the table
        function collectData() {
            const rows = document.querySelectorAll('#tableBody tr');
            const data = [];

            rows.forEach(row => {
                data.push(getRowData(row));
            });

            return data;
        }

        // Load data into the table
        function loadData(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(rowData => {
                addRow(rowData);
            });
        }

        // Save project as PDF with one shot per page
        async function saveAsPNG() {
            const rows = document.querySelectorAll('#tableBody tr');

            if (rows.length === 0) {
                alert('No shots to export!');
                return;
            }

            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            let isFirstPage = true;

            for (const row of rows) {
                if (!isFirstPage) {
                    pdf.addPage();
                }
                isFirstPage = false;

                // Create a temporary container for the shot card
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.left = '-9999px';
                container.style.top = '0';
                container.style.backgroundColor = '#000';
                container.style.color = '#fff';
                container.style.padding = '30px';
                container.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif';
                container.style.width = '800px';
                document.body.appendChild(container);

                // Get row data
                const rowData = getRowData(row);

                // Create shot card HTML (same format as individual export)
                container.innerHTML = `
                    <div style="background-color: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 25px;">
                        <h1 style="margin: 0 0 25px 0; font-size: 32px; border-bottom: 2px solid #1E90FF; padding-bottom: 15px;">
                            Shot ${rowData.shotNumber}
                        </h1>

                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">STATUS</h3>
                            <p style="margin: 0; font-size: 16px; text-transform: capitalize;">${rowData.status.replace('-', ' ')}</p>
                        </div>

                        ${rowData.notes ? `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">NOTES</h3>
                                <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.notes}</p>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">VISUAL ACTION</h3>
                            <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.visualAction || 'N/A'}</p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">AUDIO</h3>
                            <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.audio || 'N/A'}</p>
                        </div>

                        <div style="margin-bottom: ${rowData.images.length > 0 ? '20px' : '0'};">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">SHOT SPECS</h3>
                            <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.shotSpecs || 'N/A'}</p>
                        </div>

                        ${rowData.images.length > 0 ? `
                            <div>
                                <h3 style="margin: 0 0 15px 0; color: #1E90FF; font-size: 16px;">REFERENCE IMAGES</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                                    ${rowData.images.map(img => `
                                        <div style="background-color: #000; border: 1px solid #333; border-radius: 6px; padding: 10px;">
                                            <img src="${img.src}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px; display: block; margin-bottom: 10px;">
                                            ${img.caption ? `<p style="margin: 0; font-size: 13px; color: #ccc; text-align: center;">${img.caption}</p>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Use html2canvas to convert to canvas
                const canvas = await html2canvas(container, {
                    backgroundColor: '#000',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                // Add canvas as image to PDF
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                // Clean up
                document.body.removeChild(container);
            }

            // Download the PDF
            pdf.save(`storyboard_${Date.now()}.pdf`);
        }

        // Export single shot as PNG
        async function exportSingleShot(row) {
            // Create a temporary container for the shot card
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.backgroundColor = '#000';
            container.style.color = '#fff';
            container.style.padding = '30px';
            container.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif';
            container.style.width = '800px';
            document.body.appendChild(container);

            // Get row data
            const rowData = getRowData(row);

            // Create shot card HTML
            container.innerHTML = `
                <div style="background-color: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 25px;">
                    <h1 style="margin: 0 0 25px 0; font-size: 32px; border-bottom: 2px solid #1E90FF; padding-bottom: 15px;">
                        Shot ${rowData.shotNumber}
                    </h1>

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">STATUS</h3>
                        <p style="margin: 0; font-size: 16px; text-transform: capitalize;">${rowData.status.replace('-', ' ')}</p>
                    </div>

                    ${rowData.notes ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">NOTES</h3>
                            <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.notes}</p>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">VISUAL ACTION</h3>
                        <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.visualAction || 'N/A'}</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">AUDIO</h3>
                        <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.audio || 'N/A'}</p>
                    </div>

                    <div style="margin-bottom: ${rowData.images.length > 0 ? '20px' : '0'};">
                        <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">SHOT SPECS</h3>
                        <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.shotSpecs || 'N/A'}</p>
                    </div>

                    ${rowData.images.length > 0 ? `
                        <div>
                            <h3 style="margin: 0 0 15px 0; color: #1E90FF; font-size: 16px;">REFERENCE IMAGES</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                                ${rowData.images.map(img => `
                                    <div style="background-color: #000; border: 1px solid #333; border-radius: 6px; padding: 10px;">
                                        <img src="${img.src}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px; display: block; margin-bottom: 10px;">
                                        ${img.caption ? `<p style="margin: 0; font-size: 13px; color: #ccc; text-align: center;">${img.caption}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Use html2canvas to convert to PNG
            const canvas = await html2canvas(container, {
                backgroundColor: '#000',
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true
            });

            // Download the image
            const link = document.createElement('a');
            link.download = `shot_${rowData.shotNumber}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

            // Clean up
            document.body.removeChild(container);
        }

        // Save as JSON
        function saveAsJSON() {
            const data = collectData();

            // Include API key in the export
            const apiKey = localStorage.getItem('openai_api_key');
            const exportData = {
                shots: data,
                apiKey: apiKey || null
            };

            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.download = `storyboard_${Date.now()}.json`;
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        // Load from file
        function loadFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsedData = JSON.parse(e.target.result);

                    // Check if this is the new format with apiKey
                    if (parsedData.shots && Array.isArray(parsedData.shots)) {
                        // New format: { shots: [...], apiKey: "..." }
                        loadData(parsedData.shots);

                        // Restore API key if present
                        if (parsedData.apiKey) {
                            localStorage.setItem('openai_api_key', parsedData.apiKey);
                            console.log('API key restored from file');
                        }
                    } else {
                        // Old format: just array of shots
                        loadData(parsedData);
                    }

                    updateShotCounter();
                    triggerAutoSave();
                } catch (error) {
                    alert('Error loading file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Event listeners
        document.getElementById('addShotBtn').addEventListener('click', () => {
            const newRow = addRow();
            updateShotCounter();
            triggerAutoSave();

            // Scroll to new row on mobile
            setTimeout(() => {
                newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        });

        document.getElementById('savePngBtn').addEventListener('click', saveAsPNG);
        document.getElementById('saveJsonBtn').addEventListener('click', saveAsJSON);

        document.getElementById('loadFileBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadFromFile(file);
            }
        });

        // Fullscreen overlay event listeners
        document.getElementById('fullscreenClose').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeFullscreen();
        });

        document.getElementById('fullscreenOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'fullscreenOverlay') {
                closeFullscreen();
            }
        });

        // Voice input using Web Speech API
        let recognition = null;

        function startVoiceInput(textarea, micBtn) {
            // Check if browser supports speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('Voice input is not supported in your browser. Please use Chrome, Safari, or Edge.');
                return;
            }

            // If already recording, stop
            if (micBtn.classList.contains('recording')) {
                if (recognition) {
                    recognition.stop();
                }
                return;
            }

            // Create new recognition instance
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            let finalTranscript = textarea.value;

            recognition.onstart = () => {
                micBtn.classList.add('recording');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += (finalTranscript ? ' ' : '') + transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                textarea.value = finalTranscript + (interimTranscript ? ' ' + interimTranscript : '');
                triggerAutoSave();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                micBtn.classList.remove('recording');

                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access in your browser settings.');
                }
            };

            recognition.onend = () => {
                micBtn.classList.remove('recording');
                textarea.value = finalTranscript;
                triggerAutoSave();
            };

            // Start recognition
            recognition.start();
        }

        // Enhance text with AI using OpenAI API
        async function enhanceTextWithAI(textarea) {
            const text = textarea.value.trim();

            if (!text) {
                alert('Please enter some text first');
                return;
            }

            const apiKey = localStorage.getItem('openai_api_key');

            if (!apiKey) {
                alert('Please set your OpenAI API key in Settings first');
                openSettings();
                return;
            }

            // Show loading state
            const originalText = text;
            textarea.value = 'Enhancing...';
            textarea.disabled = true;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant that cleans up and clarifies text for film storyboards. Remove filler words, organize thoughts, and make the text concise and clear while keeping the exact same meaning and intent. Keep it brief and professional. Do not add any information that was not in the original text.'
                            },
                            {
                                role: 'user',
                                content: text
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 200
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const enhancedText = data.choices[0].message.content.trim();

                textarea.value = enhancedText;
                textarea.disabled = false;
                triggerAutoSave();

            } catch (error) {
                console.error('Error enhancing text:', error);
                textarea.value = originalText;
                textarea.disabled = false;
                alert('Error enhancing text. Please check your API key and try again.');
            }
        }

        // Settings modal functions
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const apiKeyInput = document.getElementById('apiKeyInput');
            // Load existing API key from localStorage
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                apiKeyInput.value = savedKey;
            }
            modal.classList.add('active');
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('active');
        }

        function saveApiKey() {
            const apiKeyInput = document.getElementById('apiKeyInput');
            const apiKey = apiKeyInput.value.trim();

            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
                alert('API key saved successfully!');
                closeSettings();
            } else {
                alert('Please enter an API key');
            }
        }

        function clearApiKey() {
            if (confirm('Are you sure you want to clear your API key?')) {
                localStorage.removeItem('openai_api_key');
                document.getElementById('apiKeyInput').value = '';
                alert('API key cleared');
            }
        }

        // Settings event listeners
        document.getElementById('settingsBtn').addEventListener('click', openSettings);
        document.getElementById('saveApiKey').addEventListener('click', saveApiKey);
        document.getElementById('clearApiKey').addEventListener('click', clearApiKey);
        document.getElementById('cancelSettings').addEventListener('click', closeSettings);

        // Close settings modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') {
                closeSettings();
            }
        });

        // Prevent closing when clicking on the image itself
        document.getElementById('fullscreenImage').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Initialize
        init();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }
    </script>
</body>
</html>
