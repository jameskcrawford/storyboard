<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storyboard</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Short film storyboard tool">
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Storyboard">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 20px;
        }

        .header {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            opacity: 0.7;
        }

        #addShotBtn,
        #savePngBtn,
        #saveJsonBtn,
        #loadFileBtn,
        #saveProjectBtn,
        #settingsBtn {
            background-color: #333;
            color: #fff;
        }

        .auto-saved {
            color: #00C853;
            font-size: 14px;
            margin-left: auto;
        }

        .shot-counter {
            color: #999;
            font-size: 14px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }

        .shot-counter .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .shot-counter .total {
            color: #fff;
            font-weight: 500;
        }

        .shot-counter .approved {
            color: #00C853;
        }

        .shot-counter .in-progress {
            color: #1E90FF;
        }


        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #333;
        }

        th {
            background-color: #1a1a1a;
            padding: 15px;
            text-align: left;
            border: 1px solid #333;
            font-weight: 500;
        }

        td {
            border: 1px solid #333;
            padding: 15px;
            vertical-align: top;
            height: 100%;
        }

        /* Text input cells need special handling for flexbox */
        td:nth-child(2),
        td:nth-child(3),
        td:nth-child(4),
        td:nth-child(6) {
            padding: 8px;
            position: relative;
        }

        .shot-number {
            width: 80px;
            text-align: center;
            font-weight: 500;
        }

        .shot-number input {
            width: 100%;
            background-color: #000;
            color: #fff;
            border: none;
            text-align: center;
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            outline: none;
        }

        .shot-number input:focus {
            background-color: #1a1a1a;
        }

        /* Textarea container with buttons */
        .textarea-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .textarea-buttons {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
            gap: 3px;
            z-index: 10;
        }

        .textarea-buttons button {
            background-color: transparent;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            padding: 0;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: #666;
        }

        /* Mic button is red */
        .textarea-buttons .mic-btn {
            color: #DC143C;
        }

        .textarea-buttons button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .textarea-buttons .mic-btn:hover {
            color: #FF1744;
        }

        .textarea-buttons button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .textarea-buttons button.recording {
            background-color: rgba(244, 67, 54, 0.3);
            color: #FF1744;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        textarea {
            width: 100%;
            background-color: #000;
            color: #fff;
            border: none;
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            padding: 8px;
            padding-bottom: 35px;
            flex: 1;
        }

        textarea:focus {
            background-color: #1a1a1a;
        }

        .reference-images-cell {
            min-width: 400px;
            max-width: 600px;
        }

        .images-container {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .images-container::-webkit-scrollbar {
            height: 8px;
        }

        .images-container::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 4px;
        }

        .images-container::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }

        .images-container::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        .image-item {
            position: relative;
            cursor: move;
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 8px;
            background-color: #1a1a1a;
            flex-shrink: 0;
        }

        .image-item.dragging {
            opacity: 0.5;
            border-color: #1E90FF;
        }

        .image-item.drag-over {
            border-color: #00C853;
        }

        .image-preview {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 4px;
            display: block;
        }

        .image-caption {
            width: 150px;
            margin-top: 8px;
            background-color: #000;
            color: #fff;
            border: 1px solid #333;
            padding: 6px;
            font-size: 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        .image-caption:focus {
            border-color: #1E90FF;
            outline: none;
        }

        .remove-image {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: #ff0000;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-image-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0;
        }

        .add-image-area {
            width: 150px;
            height: 150px;
            border: 2px dashed #666;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-image-area:hover {
            border-color: #1E90FF;
            background-color: #1a1a1a;
        }

        .add-image-area .plus {
            font-size: 36px;
            color: #666;
        }

        .add-image-area .hint {
            font-size: 11px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }

        .paste-input {
            width: 150px;
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            padding: 8px;
            font-size: 12px;
            border-radius: 4px;
            font-family: inherit;
        }

        .paste-input:focus {
            border-color: #1E90FF;
            outline: none;
        }

        .paste-input::placeholder {
            color: #666;
        }

        .status-select {
            width: 100%;
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #333;
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            font-family: inherit;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .status-select:focus {
            border-color: #1E90FF;
            outline: none;
        }

        .status-select option {
            background-color: #1a1a1a;
            color: #fff;
        }

        .status-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        .status-notes {
            width: 100%;
            background-color: #000;
            color: #fff;
            border: none;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 13px;
            outline: none;
            padding: 8px;
            padding-bottom: 35px;
            flex: 1;
        }

        .status-notes:focus {
            background-color: #1a1a1a;
        }

        .actions-cell {
            min-width: 70px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
            align-items: center;
        }

        .action-buttons button {
            background-color: transparent;
            color: #999;
            font-size: 20px;
            padding: 6px;
            border: none;
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .action-buttons button:hover {
            color: #fff;
            background-color: #333;
            border-radius: 4px;
        }

        .drag-handle {
            cursor: grab;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle:hover {
            color: #1E90FF;
        }

        .duplicate-row:hover {
            color: #00C853;
        }

        .export-shot:hover {
            color: #1E90FF;
        }

        .delete-row:hover {
            color: #ff0000;
        }

        .lock-toggle:hover {
            color: #FF9800;
        }

        .lock-toggle[data-locked="true"] {
            color: #F44336;
        }

        .lock-toggle[data-locked="true"]:hover {
            color: #ff5555;
        }

        tr.dragging {
            opacity: 0.5;
            background-color: #1a1a1a;
        }

        tr.drag-over {
            border-top: 3px solid #1E90FF;
        }

        tr.locked {
            opacity: 0.6;
            background-color: #1a1a1a;
        }

        tr.locked textarea,
        tr.locked input,
        tr.locked select {
            pointer-events: none;
            background-color: #0a0a0a !important;
        }

        tr.locked .drag-handle,
        tr.locked .duplicate-row,
        tr.locked .delete-row {
            pointer-events: none;
            opacity: 0.3;
        }

        input[type="file"] {
            display: none;
        }

        .fullscreen-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-image {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
        }

        .fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #ff0000;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .fullscreen-close:hover {
            background-color: #cc0000;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal.active {
            display: flex;
        }

        .settings-content {
            background-color: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .settings-content h2 {
            margin: 0 0 20px 0;
            color: #1E90FF;
            font-size: 24px;
        }

        .settings-content label {
            display: block;
            margin-bottom: 8px;
            color: #fff;
            font-size: 14px;
        }

        .settings-content input[type="password"],
        .settings-content input[type="text"] {
            width: 100%;
            padding: 10px;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .settings-content .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .settings-content .button-group button {
            flex: 1;
        }

        .settings-content .save-btn {
            background-color: #1E90FF;
            color: #fff;
        }

        .settings-content .clear-btn {
            background-color: #F44336;
            color: #fff;
        }

        .settings-content .cancel-btn {
            background-color: #333;
            color: #fff;
        }

        .settings-content .info-text {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
            line-height: 1.5;
        }

        .settings-content .info-text a {
            color: #1E90FF;
            text-decoration: none;
        }

        .settings-content .info-text a:hover {
            text-decoration: underline;
        }

        /* Mobile - Portrait */
        @media (max-width: 768px) and (orientation: portrait) {
            body {
                padding: 8px;
            }

            .header {
                gap: 6px;
                flex-direction: column;
                align-items: stretch;
            }

            .header button {
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Hide PDF button in portrait mode (available in settings) */
            #savePngBtn {
                display: none;
            }

            .shot-counter {
                justify-content: flex-start;
                gap: 10px;
                font-size: 13px;
            }

            .auto-saved {
                margin-left: 0;
            }

            /* Allow horizontal scrolling in portrait mode */
            .table-container {
                overflow-x: auto;
            }

            th, td {
                padding: 12px;
                font-size: 14px;
            }

            .shot-number {
                width: 70px;
            }

            /* Wider columns in portrait mode for better readability */
            th:nth-child(2), /* Visual Action */
            td:nth-child(2) {
                min-width: 250px;
            }

            th:nth-child(3), /* Audio */
            td:nth-child(3) {
                min-width: 250px;
            }

            th:nth-child(4), /* Shot Specs */
            td:nth-child(4) {
                min-width: 250px;
            }

            th:nth-child(6), /* Status */
            td:nth-child(6) {
                min-width: 200px;
            }

            textarea {
                min-height: 120px;
                font-size: 15px;
                line-height: 1.5;
                padding: 10px;
            }

            textarea::placeholder {
                font-size: 14px;
                line-height: 1.4;
            }

            /* Mic and enhance buttons in portrait */
            .textarea-buttons {
                flex-direction: row;
                gap: 6px;
                padding: 6px;
            }

            .textarea-buttons button {
                width: 24px;
                height: 24px;
                font-size: 13px;
            }

            .reference-images-cell {
                min-width: 300px;
            }

            .image-preview,
            .add-image-area {
                width: 120px;
                height: 120px;
            }

            .image-caption,
            .paste-input {
                width: 120px;
                font-size: 13px;
            }

            .action-buttons button {
                width: 40px;
                height: 40px;
                font-size: 22px;
            }
        }

        /* Mobile - Landscape (Your primary use case) */
        @media (max-width: 926px) and (orientation: landscape) {
            body {
                padding: 2px;
            }

            .header {
                gap: 3px;
                margin-bottom: 4px;
            }

            .header button {
                padding: 4px 6px;
                font-size: 9px;
            }

            .shot-counter {
                gap: 4px;
                font-size: 8px;
            }

            .shot-counter .stat {
                white-space: nowrap;
            }

            .auto-saved {
                font-size: 8px;
            }

            th {
                padding: 3px;
                font-size: 9px;
                white-space: nowrap;
            }

            td {
                padding: 3px;
                font-size: 9px;
            }

            .shot-number {
                width: 32px;
                min-width: 32px;
                max-width: 32px;
            }

            .shot-number input {
                font-size: 9px;
                padding: 1px;
            }

            /* Make textareas fit and show full placeholder */
            textarea {
                min-height: 85px;
                max-height: 110px;
                font-size: 9px;
                padding: 3px;
                width: 100%;
                line-height: 1.3;
                overflow-y: auto;
            }

            textarea::placeholder {
                font-size: 8px;
                line-height: 1.3;
                white-space: pre-wrap;
            }

            .status-select {
                font-size: 8px;
                padding: 2px;
            }

            .status-notes {
                min-height: 25px;
                font-size: 8px;
            }

            /* Fixed table layout to control widths */
            table {
                font-size: 9px;
                table-layout: fixed;
                width: 100%;
            }

            /* Precise column widths for landscape fit */
            th:nth-child(1) { width: 32px; } /* Shot # */
            th:nth-child(2) { width: 17%; }  /* Visual Action */
            th:nth-child(3) { width: 17%; }  /* Audio */
            th:nth-child(4) { width: 17%; }  /* Shot Specs */
            th:nth-child(5) { width: 20%; }  /* Reference Images */
            th:nth-child(6) { width: 11%; }  /* Status */
            th:nth-child(7) { width: 35px; } /* Actions */

            .reference-images-cell {
                min-width: unset;
                max-width: unset;
            }

            .images-container {
                gap: 6px;
            }

            .image-preview,
            .add-image-area {
                width: 60px;
                height: 60px;
            }

            .image-caption,
            .paste-input {
                width: 60px;
                font-size: 7px;
            }

            .add-image-area .plus {
                font-size: 20px;
            }

            .add-image-area .hint {
                font-size: 7px;
            }

            .action-buttons {
                gap: 1px;
            }

            .action-buttons button {
                width: 26px;
                height: 26px;
                font-size: 14px;
                padding: 2px;
            }

            .actions-cell {
                min-width: 35px;
                max-width: 35px;
            }

            /* Hide lock button to save space */
            .lock-toggle {
                display: none;
            }
        }

        /* Tablet and smaller desktop */
        @media (min-width: 769px) and (max-width: 1024px) {
            .reference-images-cell {
                min-width: 350px;
                max-width: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="addShotBtn">+ Add Shot</button>
        <select id="projectSelector" style="padding: 10px; background-color: #333; color: #fff; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">
            <option value="">Select Project...</option>
        </select>
        <button id="saveProjectBtn">💾 Save Project</button>
        <button id="savePngBtn">📄 Save Project as PDF</button>
        <button id="settingsBtn">⚙️ Settings</button>
        <input type="file" id="fileInput" accept=".json">
        <div class="shot-counter" id="shotCounter">
            <div class="stat total"><span id="totalShots">0</span> shots</div>
            <div class="stat approved"><span id="approvedShots">0</span> approved</div>
            <div class="stat in-progress"><span id="inProgressShots">0</span> in progress</div>
        </div>
    </div>

    <div class="table-container">
        <table id="storyboardTable">
            <thead>
                <tr>
                    <th>Shot #</th>
                    <th>Visual Action</th>
                    <th>Audio</th>
                    <th>Shot Specs</th>
                    <th>Reference Images</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <button class="fullscreen-close" id="fullscreenClose">×</button>
        <img class="fullscreen-image" id="fullscreenImage" src="" alt="Fullscreen view">
    </div>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2>Settings</h2>

            <!-- Project Name Section -->
            <label for="projectNameInput">Project Name</label>
            <input type="text" id="projectNameInput" placeholder="Enter your project name...">
            <p class="info-text">
                This name will appear in exported files and the page title.
            </p>

            <!-- API Key Section -->
            <label for="apiKeyInput" style="margin-top: 20px;">OpenAI API Key</label>
            <input type="password" id="apiKeyInput" placeholder="sk-...">
            <p class="info-text">
                Your API key is stored locally on your device only and is never shared.
                It's only used when you click the ✨ enhance button.
                <br><br>
                Don't have an API key? <a href="https://platform.openai.com/api-keys" target="_blank">Get one here</a>
            </p>

            <!-- R2 Storage Section -->
            <label for="r2ConfigToggle" style="margin-top: 20px;">Video Storage (Cloudflare R2)</label>
            <p class="info-text" style="margin-top: 0;">
                R2 credentials are pre-configured for video uploads.
            </p>

            <div class="button-group">
                <button class="save-btn" id="saveSettings">Save</button>
                <button class="clear-btn" id="clearApiKey">Clear API Key</button>
            </div>

            <!-- Action Buttons -->
            <div class="settings-actions" style="display: block;">
                <h3 style="margin: 25px 0 15px 0; color: #1E90FF; font-size: 18px;">Project Actions</h3>
                <div class="button-group" style="flex-direction: column;">
                    <button id="modalSavePdf" style="background-color: #333; color: #fff;">📄 Save Project as PDF</button>
                    <button id="modalDownloadBackup" style="background-color: #333; color: #fff;">💾 Download Backup</button>
                    <button id="modalLoadFile" style="background-color: #333; color: #fff;">📁 Load from File</button>
                </div>
            </div>

            <!-- Delete Project Section -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #333;">
                <h3 style="margin: 0 0 15px 0; color: #F44336; font-size: 18px;">Danger Zone</h3>
                <label for="deleteProjectSelect">Delete a Project</label>
                <select id="deleteProjectSelect" style="width: 100%; padding: 10px; background-color: #000; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 14px; margin-top: 8px;">
                    <option value="">Select a project to delete...</option>
                </select>
                <div class="button-group" style="margin-top: 15px;">
                    <button id="deleteProjectBtn" style="background-color: #F44336; color: #fff; width: 100%;">🗑️ Delete Project</button>
                </div>
                <p class="info-text" style="margin-top: 10px;">
                    Warning: This will permanently delete the project and all associated videos from cloud storage.
                </p>
            </div>

            <!-- Cancel Button -->
            <div class="button-group" style="margin-top: 20px;">
                <button class="cancel-btn" id="cancelSettings">Close</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let autoSaveTimeout;
        let currentProjectId = null;

        // R2 Configuration
        const R2_CONFIG = {
            accountId: 'cfddc259c7ddc0377bbbbea16390edaa',
            bucketName: 'storyboard-videos',
            accessKeyId: '08a6c5a94bc1b3b4ec16cabf48ffb63d',
            secretAccessKey: 'd94c8151d8e4127d4db8a18e44c5b9b4559bb6c3a760bbaf345887023f3e2241',
            endpoint: `https://cfddc259c7ddc0377bbbbea16390edaa.r2.cloudflarestorage.com`,
            publicUrl: `https://pub-3669964d34ee4753bf5ef4fd2260be44.r2.dev`
        };

        // Save project to R2 cloud
        async function saveProjectToCloud(projectName, projectData) {
            try {
                const projectId = projectName.replace(/[^a-zA-Z0-9-_]/g, '_').toLowerCase();
                const fileName = `projects/${projectId}.json`;

                const projectFile = {
                    id: projectId,
                    name: projectName,
                    lastModified: new Date().toISOString(),
                    data: projectData
                };

                const jsonContent = JSON.stringify(projectFile);

                // Upload with AWS Signature V4
                await uploadToR2(fileName, jsonContent, 'application/json');

                // Update project list
                await updateProjectList(projectId, projectName);

                console.log('Project saved to cloud:', projectName);
                return projectId;

            } catch (error) {
                console.error('Error saving project to cloud:', error);
                // Fallback to localStorage
                saveToLocalStorage();
                throw error;
            }
        }

        // Generic R2 upload with AWS Signature V4
        async function uploadToR2(fileName, content, contentType) {
            const url = `${R2_CONFIG.endpoint}/${R2_CONFIG.bucketName}/${fileName}`;

            const encoder = new TextEncoder();
            const data = typeof content === 'string' ? encoder.encode(content) : content;

            const date = new Date();
            const amzDate = date.toISOString().replace(/[:-]|\.\d{3}/g, '');
            const dateStamp = amzDate.substring(0, 8);

            // Calculate payload hash
            const payloadHash = await sha256(data);

            // Create canonical request
            const canonicalRequest = [
                'PUT',
                `/${R2_CONFIG.bucketName}/${fileName}`,
                '',
                `host:${R2_CONFIG.accountId}.r2.cloudflarestorage.com`,
                `x-amz-content-sha256:${payloadHash}`,
                `x-amz-date:${amzDate}`,
                '',
                'host;x-amz-content-sha256;x-amz-date',
                payloadHash
            ].join('\n');

            const canonicalRequestHash = await sha256Hex(canonicalRequest);

            // Create string to sign
            const credentialScope = `${dateStamp}/auto/s3/aws4_request`;
            const stringToSign = [
                'AWS4-HMAC-SHA256',
                amzDate,
                credentialScope,
                canonicalRequestHash
            ].join('\n');

            // Calculate signature
            const signature = await calculateSignature(R2_CONFIG.secretAccessKey, dateStamp, stringToSign);

            // Create authorization header
            const authorization = `AWS4-HMAC-SHA256 Credential=${R2_CONFIG.accessKeyId}/${credentialScope}, SignedHeaders=host;x-amz-content-sha256;x-amz-date, Signature=${signature}`;

            // Make the request
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Host': `${R2_CONFIG.accountId}.r2.cloudflarestorage.com`,
                    'x-amz-content-sha256': payloadHash,
                    'x-amz-date': amzDate,
                    'Authorization': authorization,
                    'Content-Type': contentType
                },
                body: data
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('R2 Upload Error:', {
                    status: response.status,
                    statusText: response.statusText,
                    error: errorText,
                    url: url,
                    headers: {
                        'x-amz-content-sha256': payloadHash,
                        'x-amz-date': amzDate,
                        'Authorization': authorization
                    }
                });
                throw new Error(`Upload failed: ${response.status} - ${errorText}`);
            }

            return response;
        }

        // SHA256 helper for text
        async function sha256Hex(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Calculate AWS Signature V4 signature
        async function calculateSignature(secretKey, dateStamp, stringToSign) {
            const kDate = await hmac(`AWS4${secretKey}`, dateStamp);
            const kRegion = await hmac(kDate, 'auto');
            const kService = await hmac(kRegion, 's3');
            const kSigning = await hmac(kService, 'aws4_request');
            const signature = await hmac(kSigning, stringToSign);

            // Convert to hex
            const hashArray = Array.from(new Uint8Array(signature));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // HMAC-SHA256 helper
        async function hmac(key, data) {
            const keyData = typeof key === 'string' ? new TextEncoder().encode(key) : key;
            const messageData = new TextEncoder().encode(data);

            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );

            return await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        }

        // Load project from R2 cloud
        async function loadProjectFromCloud(projectId) {
            try {
                const fileName = `projects/${projectId}.json`;
                const url = `${R2_CONFIG.publicUrl}/${fileName}`;

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Failed to load project: ${response.status}`);
                }

                const projectFile = await response.json();

                currentProjectId = projectId;
                localStorage.setItem('currentProjectId', projectId);

                // Update project name
                if (projectFile.name) {
                    updateProjectName(projectFile.name);
                    localStorage.setItem('project_name', projectFile.name);
                }

                // Load the data
                loadData(projectFile.data);
                updateShotCounter();

                console.log('Project loaded from cloud:', projectFile.name);

            } catch (error) {
                console.error('Error loading project from cloud:', error);
                alert('Failed to load project: ' + error.message);
            }
        }

        // Update project list (stored as index in R2)
        async function updateProjectList(projectId, projectName) {
            try {
                // Fetch existing project list
                const listUrl = `${R2_CONFIG.publicUrl}/projects/index.json`;
                let projectList = {};

                try {
                    const response = await fetch(listUrl);
                    if (response.ok) {
                        projectList = await response.json();
                    }
                } catch (e) {
                    // First time, no index exists yet
                }

                // Add/update project in list
                projectList[projectId] = {
                    name: projectName,
                    lastModified: new Date().toISOString()
                };

                // Save updated list with proper authentication
                await uploadToR2('projects/index.json', JSON.stringify(projectList), 'application/json');

            } catch (error) {
                console.error('Error updating project list:', error);
            }
        }

        // Load project list from R2
        async function loadProjectList() {
            try {
                const listUrl = `${R2_CONFIG.publicUrl}/projects/index.json`;
                const response = await fetch(listUrl);

                if (!response.ok) {
                    return {};
                }

                const projectList = await response.json();

                // Update selector
                const selector = document.getElementById('projectSelector');
                selector.innerHTML = '<option value="">Select Project...</option>';

                for (const [id, info] of Object.entries(projectList)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${info.name} (${new Date(info.lastModified).toLocaleDateString()})`;
                    selector.appendChild(option);
                }

                return projectList;

            } catch (error) {
                console.error('Error loading project list:', error);
                return {};
            }
        }

        // Upload video to R2
        async function uploadVideoToR2(file, container) {
            try {
                // Ensure we have a project
                if (!currentProjectId) {
                    alert('Please create or select a project first');
                    return;
                }

                // Generate unique filename with project folder
                const timestamp = Date.now();
                const sanitizedFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const fileName = `videos/${currentProjectId}/${timestamp}_${sanitizedFileName}`;
                const url = `${R2_CONFIG.endpoint}/${R2_CONFIG.bucketName}/${fileName}`;

                // Show upload progress
                const uploadingDiv = document.createElement('div');
                uploadingDiv.className = 'image-item';
                uploadingDiv.innerHTML = `
                    <div style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; background: #1a1a1a; border-radius: 4px;">
                        <p style="color: #fff; font-size: 12px;">Uploading video...</p>
                    </div>
                `;
                const wrapper = container.querySelector('.add-image-wrapper');
                if (wrapper) {
                    container.insertBefore(uploadingDiv, wrapper);
                }

                // Create AWS Signature V4
                const date = new Date();
                const dateStamp = date.toISOString().split('T')[0].replace(/-/g, '');
                const amzDate = date.toISOString().replace(/[:-]|\.\d{3}/g, '');

                // Read file as ArrayBuffer for upload
                const arrayBuffer = await file.arrayBuffer();

                // Upload to R2 with proper authentication
                await uploadToR2(fileName, arrayBuffer, file.type);

                // Remove uploading indicator
                uploadingDiv.remove();

                // Add video to container with public URL
                const publicUrl = `${R2_CONFIG.publicUrl}/${fileName}`;
                addImageToContainer(container, publicUrl, '', 'video');
                triggerAutoSave();

                console.log('Video uploaded successfully:', publicUrl);

            } catch (error) {
                console.error('Error uploading video:', error);
                alert('Failed to upload video: ' + error.message);
            }
        }

        // Simple SHA256 hash function
        async function sha256(data) {
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Initialize with 5 rows
        async function init() {
            // Load project list
            await loadProjectList();

            // Check if we have a current project
            const savedProjectId = localStorage.getItem('currentProjectId');

            if (savedProjectId) {
                // Load last project from cloud
                currentProjectId = savedProjectId;
                try {
                    await loadProjectFromCloud(savedProjectId);

                    // Select in dropdown
                    const selector = document.getElementById('projectSelector');
                    selector.value = savedProjectId;
                } catch (error) {
                    console.error('Failed to load last project:', error);
                    // Fall back to localStorage
                    loadFromLocalStorage();
                }
            } else {
                // No project yet, load from localStorage if available
                loadFromLocalStorage();
            }
        }

        // Load from localStorage (fallback)
        function loadFromLocalStorage() {
            const savedProjectName = localStorage.getItem('project_name');
            if (savedProjectName) {
                updateProjectName(savedProjectName);
            }

            const savedData = localStorage.getItem('storyboardData');
            if (savedData) {
                loadData(JSON.parse(savedData));
            } else {
                for (let i = 0; i < 5; i++) {
                    addRow();
                }
            }
            updateShotCounter();
        }

        // Get next shot number
        function getNextShotNumber() {
            const rows = document.querySelectorAll('#tableBody tr');
            if (rows.length === 0) {
                return '001';
            }

            const lastRow = rows[rows.length - 1];
            const lastShotInput = lastRow.querySelector('.shot-number-input');
            if (lastShotInput) {
                const lastNum = parseInt(lastShotInput.value) || rows.length;
                return String(lastNum + 1).padStart(3, '0');
            }

            return String(rows.length + 1).padStart(3, '0');
        }

        // Add a new row
        function addRow(data = null) {
            const tbody = document.getElementById('tableBody');
            const row = document.createElement('tr');

            const shotNum = data?.shotNumber || getNextShotNumber();

            row.innerHTML = `
                <td class="shot-number"><input type="text" class="shot-number-input" value="${shotNum}"></td>
                <td>
                    <div class="textarea-container">
                        <textarea class="visual-action" placeholder="What do we see? What's happening?">${data?.visualAction || data?.shotDescription || ''}</textarea>
                        <div class="textarea-buttons">
                            <button class="enhance-btn" title="Enhance with AI">✨</button>
                            <button class="mic-btn" title="Voice Input">●</button>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="textarea-container">
                        <textarea class="audio" placeholder="What do we hear? Dialogue? Music? Sounds?">${data?.audio || data?.dialogue || ''}</textarea>
                        <div class="textarea-buttons">
                            <button class="enhance-btn" title="Enhance with AI">✨</button>
                            <button class="mic-btn" title="Voice Input">●</button>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="textarea-container">
                        <textarea class="shot-specs" placeholder="How do we film this? (e.g., CU, low angle, pan left)">${data?.shotSpecs || data?.subjects || ''}</textarea>
                        <div class="textarea-buttons">
                            <button class="enhance-btn" title="Enhance with AI">✨</button>
                            <button class="mic-btn" title="Voice Input">●</button>
                        </div>
                    </div>
                </td>
                <td class="reference-images-cell">
                    <div class="images-container"></div>
                </td>
                <td>
                    <div class="status-container">
                        <select class="status-select">
                            <option value="planned" ${(data?.status || 'planned') === 'planned' ? 'selected' : ''}>Planned</option>
                            <option value="in-progress" ${data?.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="shot" ${data?.status === 'shot' ? 'selected' : ''}>Shot</option>
                            <option value="approved" ${data?.status === 'approved' ? 'selected' : ''}>Approved</option>
                            <option value="needs-reshoot" ${data?.status === 'needs-reshoot' ? 'selected' : ''}>Needs Reshoot</option>
                        </select>
                        <textarea class="status-notes" placeholder="Add notes...">${data?.notes || ''}</textarea>
                        <div class="textarea-buttons">
                            <button class="enhance-btn" title="Enhance with AI">✨</button>
                            <button class="mic-btn" title="Voice Input">●</button>
                        </div>
                    </div>
                </td>
                <td class="actions-cell">
                    <div class="action-buttons">
                        <button class="drag-handle" title="Drag to Reorder">☰</button>
                        <button class="duplicate-row" title="Duplicate Shot">⧉</button>
                        <button class="lock-toggle" title="${data?.locked ? 'Unlock Shot' : 'Lock Shot'}" data-locked="${data?.locked ? 'true' : 'false'}">${data?.locked ? '🔒' : '🔓'}</button>
                        <button class="export-shot" title="Export Shot as PNG">⎙</button>
                        <button class="delete-row" title="Delete Shot">×</button>
                    </div>
                </td>
            `;

            tbody.appendChild(row);

            // Apply locked class if needed
            if (data?.locked) {
                row.classList.add('locked');
            }

            // Add event listeners for text areas, shot number input, status select, and status notes
            row.querySelectorAll('textarea, .shot-number-input, .status-select').forEach(input => {
                input.addEventListener('input', triggerAutoSave);
                if (input.tagName === 'SELECT') {
                    input.addEventListener('change', () => {
                        triggerAutoSave();
                        updateShotCounter();
                    });
                }
            });

            // Drag and drop functionality
            const dragHandle = row.querySelector('.drag-handle');
            let touchStartY = 0;
            let touchCurrentY = 0;
            let isDragging = false;

            // Desktop drag and drop
            dragHandle.addEventListener('mousedown', () => {
                row.setAttribute('draggable', 'true');
            });

            dragHandle.addEventListener('mouseup', () => {
                row.setAttribute('draggable', 'false');
            });

            // Mobile touch-based drag and drop
            dragHandle.addEventListener('touchstart', (e) => {
                if (row.classList.contains('locked')) return;

                touchStartY = e.touches[0].clientY;
                isDragging = true;
                row.style.opacity = '0.5';
                row.style.position = 'relative';
                e.preventDefault();
            });

            dragHandle.addEventListener('touchmove', (e) => {
                if (!isDragging) return;

                touchCurrentY = e.touches[0].clientY;
                const deltaY = touchCurrentY - touchStartY;
                row.style.transform = `translateY(${deltaY}px)`;

                // Find which row we're over
                const allRows = [...document.querySelectorAll('#tableBody tr')];
                const rowHeight = row.offsetHeight;
                const currentIndex = allRows.indexOf(row);
                const moveByRows = Math.round(deltaY / rowHeight);
                const targetIndex = currentIndex + moveByRows;

                // Remove all drag-over classes
                allRows.forEach(r => r.classList.remove('drag-over'));

                // Add drag-over to target row
                if (targetIndex >= 0 && targetIndex < allRows.length && targetIndex !== currentIndex) {
                    allRows[targetIndex].classList.add('drag-over');
                }

                e.preventDefault();
            });

            dragHandle.addEventListener('touchend', (e) => {
                if (!isDragging) return;

                isDragging = false;
                row.style.opacity = '';
                row.style.transform = '';
                row.style.position = '';

                const allRows = [...document.querySelectorAll('#tableBody tr')];
                const rowHeight = row.offsetHeight;
                const currentIndex = allRows.indexOf(row);
                const deltaY = touchCurrentY - touchStartY;
                const moveByRows = Math.round(deltaY / rowHeight);
                const targetIndex = currentIndex + moveByRows;

                // Actually move the row
                if (targetIndex >= 0 && targetIndex < allRows.length && targetIndex !== currentIndex) {
                    const targetRow = allRows[targetIndex];
                    if (targetIndex > currentIndex) {
                        targetRow.after(row);
                    } else {
                        targetRow.before(row);
                    }
                    renumberShots();
                    triggerAutoSave();
                }

                // Remove all drag-over classes
                allRows.forEach(r => r.classList.remove('drag-over'));

                e.preventDefault();
            });

            row.addEventListener('dragstart', (e) => {
                if (row.classList.contains('locked')) {
                    e.preventDefault();
                    return;
                }
                row.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            row.addEventListener('dragend', () => {
                row.classList.remove('dragging');
                row.setAttribute('draggable', 'false');
                document.querySelectorAll('#tableBody tr').forEach(r => {
                    r.classList.remove('drag-over');
                });
                renumberShots();
                triggerAutoSave();
            });

            row.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingRow = document.querySelector('#tableBody tr.dragging');
                if (draggingRow && draggingRow !== row) {
                    row.classList.add('drag-over');
                }
            });

            row.addEventListener('dragleave', () => {
                row.classList.remove('drag-over');
            });

            row.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggingRow = document.querySelector('#tableBody tr.dragging');
                if (draggingRow && draggingRow !== row) {
                    const allRows = [...document.querySelectorAll('#tableBody tr')];
                    const draggingIndex = allRows.indexOf(draggingRow);
                    const targetIndex = allRows.indexOf(row);

                    if (draggingIndex < targetIndex) {
                        row.after(draggingRow);
                    } else {
                        row.before(draggingRow);
                    }
                }
                row.classList.remove('drag-over');
            });

            // Lock/unlock functionality
            const lockToggle = row.querySelector('.lock-toggle');
            lockToggle.addEventListener('click', () => {
                const isLocked = lockToggle.getAttribute('data-locked') === 'true';

                if (isLocked) {
                    lockToggle.setAttribute('data-locked', 'false');
                    lockToggle.textContent = '🔓';
                    lockToggle.title = 'Lock Shot';
                    row.classList.remove('locked');
                } else {
                    lockToggle.setAttribute('data-locked', 'true');
                    lockToggle.textContent = '🔒';
                    lockToggle.title = 'Unlock Shot';
                    row.classList.add('locked');
                }
                triggerAutoSave();
            });

            // Duplicate row functionality
            row.querySelector('.duplicate-row').addEventListener('click', () => {
                const rowData = getRowData(row);
                const newRow = addRow(rowData);
                row.after(newRow);
                renumberShots();
                updateShotCounter();
                triggerAutoSave();
            });

            // Export shot functionality
            row.querySelector('.export-shot').addEventListener('click', () => {
                exportSingleShot(row);
            });

            // Delete row functionality
            row.querySelector('.delete-row').addEventListener('click', () => {
                if (confirm('Are you sure you want to delete this shot?')) {
                    row.remove();
                    renumberShots();
                    updateShotCounter();
                    triggerAutoSave();
                }
            });

            // Setup microphone and enhance buttons
            const micButtons = row.querySelectorAll('.mic-btn');
            const enhanceButtons = row.querySelectorAll('.enhance-btn');

            micButtons.forEach(micBtn => {
                micBtn.addEventListener('click', () => {
                    const container = micBtn.closest('.textarea-container') || micBtn.closest('.status-container');
                    const textarea = container.querySelector('textarea');
                    startVoiceInput(textarea, micBtn);
                });
            });

            enhanceButtons.forEach(enhanceBtn => {
                enhanceBtn.addEventListener('click', () => {
                    const container = enhanceBtn.closest('.textarea-container') || enhanceBtn.closest('.status-container');
                    const textarea = container.querySelector('textarea');
                    enhanceTextWithAI(textarea);
                });
            });

            // Setup image area
            const imagesContainer = row.querySelector('.images-container');
            setupImageArea(imagesContainer, data?.images || []);

            return row;
        }

        // Renumber shots after deletion
        function renumberShots() {
            const rows = document.querySelectorAll('#tableBody tr');
            rows.forEach((row, index) => {
                const shotNumberInput = row.querySelector('.shot-number-input');
                if (shotNumberInput) {
                    shotNumberInput.value = String(index + 1).padStart(3, '0');
                }
            });
        }

        // Get data from a single row
        function getRowData(row) {
            const shotNumber = row.querySelector('.shot-number-input').value;
            const visualAction = row.querySelector('.visual-action').value;
            const audio = row.querySelector('.audio').value;
            const shotSpecs = row.querySelector('.shot-specs').value;
            const status = row.querySelector('.status-select').value;
            const notes = row.querySelector('.status-notes').value;
            const locked = row.querySelector('.lock-toggle').getAttribute('data-locked') === 'true';

            const images = [];
            row.querySelectorAll('.image-item').forEach(imageItem => {
                const media = imageItem.querySelector('.image-preview');
                const caption = imageItem.querySelector('.image-caption').value;
                const mediaType = imageItem.dataset.mediaType || 'image';
                images.push({
                    src: media.src,
                    caption: caption,
                    type: mediaType
                });
            });

            return {
                shotNumber,
                visualAction,
                audio,
                shotSpecs,
                status,
                notes,
                locked,
                images
            };
        }

        // Update shot counter
        function updateShotCounter() {
            const rows = document.querySelectorAll('#tableBody tr');
            const total = rows.length;
            let approved = 0;
            let inProgress = 0;

            rows.forEach(row => {
                const status = row.querySelector('.status-select').value;
                if (status === 'approved') {
                    approved++;
                } else if (status === 'in-progress' || status === 'shot' || status === 'needs-reshoot') {
                    inProgress++;
                }
            });

            document.getElementById('totalShots').textContent = total;
            document.getElementById('approvedShots').textContent = approved;
            document.getElementById('inProgressShots').textContent = inProgress;
        }

        // Setup image area with paste and click functionality
        function setupImageArea(container, existingImages = []) {
            // Create add image button first
            updateAddButton(container);

            // Add existing images/videos
            existingImages.forEach(imageData => {
                const mediaType = imageData.type || 'image';
                addImageToContainer(container, imageData.src, imageData.caption, mediaType);
            });
        }

        // Add image to container
        function addImageToContainer(container, mediaSrc, caption = '', mediaType = 'image') {
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.draggable = true;
            imageItem.dataset.mediaType = mediaType;

            const mediaElement = mediaType === 'video'
                ? `<video src="${mediaSrc}" class="image-preview" controls></video>`
                : `<img src="${mediaSrc}" class="image-preview">`;

            imageItem.innerHTML = `
                <button class="remove-image">×</button>
                ${mediaElement}
                <input type="text" class="image-caption" placeholder="Add caption..." value="${caption}">
            `;

            // Insert before the add-image-wrapper
            const wrapper = container.querySelector('.add-image-wrapper');
            if (wrapper) {
                container.insertBefore(imageItem, wrapper);
            } else {
                container.appendChild(imageItem);
            }

            // Add drag and drop functionality
            setupDragAndDrop(imageItem, container);

            // Remove image functionality
            imageItem.querySelector('.remove-image').addEventListener('click', () => {
                imageItem.remove();
                triggerAutoSave();
            });

            // Caption input
            imageItem.querySelector('.image-caption').addEventListener('input', triggerAutoSave);

            // Double-click to fullscreen (images only)
            const mediaPreview = imageItem.querySelector('.image-preview');
            if (mediaType === 'image') {
                mediaPreview.addEventListener('dblclick', () => {
                    showFullscreen(mediaSrc);
                });
            }
        }

        // Show image in fullscreen
        function showFullscreen(imageSrc) {
            const overlay = document.getElementById('fullscreenOverlay');
            const fullscreenImg = document.getElementById('fullscreenImage');
            fullscreenImg.src = imageSrc;
            overlay.classList.add('active');
        }

        // Close fullscreen
        function closeFullscreen() {
            const overlay = document.getElementById('fullscreenOverlay');
            overlay.classList.remove('active');
        }

        // Update add button
        function updateAddButton(container) {
            let wrapper = container.querySelector('.add-image-wrapper');
            if (!wrapper) {
                wrapper = document.createElement('div');
                wrapper.className = 'add-image-wrapper';

                // Create upload button
                const addButton = document.createElement('div');
                addButton.className = 'add-image-area';
                addButton.innerHTML = `
                    <div class="plus">+</div>
                    <div class="hint">Upload Image/Video</div>
                `;

                addButton.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*,video/*';
                    input.multiple = true;
                    input.onchange = async (e) => {
                        const files = Array.from(e.target.files);
                        for (const file of files) {
                            if (file.type.startsWith('video/')) {
                                // Upload video to R2
                                await uploadVideoToR2(file, container);
                            } else {
                                // Handle image as before
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    addImageToContainer(container, event.target.result, '', 'image');
                                    triggerAutoSave();
                                };
                                reader.readAsDataURL(file);
                            }
                        }
                    };
                    input.click();
                });

                // Create paste input
                const pasteInput = document.createElement('input');
                pasteInput.type = 'text';
                pasteInput.className = 'paste-input';
                pasteInput.placeholder = 'Paste image here...';

                pasteInput.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const items = e.clipboardData.items;
                    for (let item of items) {
                        if (item.type.indexOf('image') !== -1) {
                            const file = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                addImageToContainer(container, event.target.result);
                                pasteInput.value = '';
                                triggerAutoSave();
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                });

                wrapper.appendChild(addButton);
                wrapper.appendChild(pasteInput);
                container.appendChild(wrapper);
            }
        }

        // Drag and drop functionality
        function setupDragAndDrop(item, container) {
            item.addEventListener('dragstart', (e) => {
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
                container.querySelectorAll('.image-item').forEach(i => {
                    i.classList.remove('drag-over');
                });
                triggerAutoSave();
            });

            item.addEventListener('dragover', (e) => {
                e.preventDefault();
                const draggingItem = container.querySelector('.dragging');
                if (draggingItem && draggingItem !== item) {
                    item.classList.add('drag-over');
                }
            });

            item.addEventListener('dragleave', () => {
                item.classList.remove('drag-over');
            });

            item.addEventListener('drop', (e) => {
                e.preventDefault();
                const draggingItem = container.querySelector('.dragging');
                if (draggingItem && draggingItem !== item) {
                    const allItems = [...container.querySelectorAll('.image-item')];
                    const draggingIndex = allItems.indexOf(draggingItem);
                    const targetIndex = allItems.indexOf(item);

                    if (draggingIndex < targetIndex) {
                        item.after(draggingItem);
                    } else {
                        item.before(draggingItem);
                    }
                }
                item.classList.remove('drag-over');
            });
        }

        // Auto-save functionality
        function triggerAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                const data = collectData();

                // Save to localStorage as backup
                localStorage.setItem('storyboardData', JSON.stringify(data));

                // Save to cloud if we have a project
                if (currentProjectId) {
                    const projectName = localStorage.getItem('project_name') || 'Untitled Project';
                    try {
                        await saveProjectToCloud(projectName, data);
                    } catch (error) {
                        console.error('Cloud save failed, using localStorage backup');
                    }
                }

                showAutoSavedIndicator();
            }, 500);
        }

        function saveToLocalStorage() {
            const data = collectData();
            localStorage.setItem('storyboardData', JSON.stringify(data));
        }

        function showAutoSavedIndicator() {
            // Auto-save indicator removed - project name shown in dropdown
        }

        // Collect all data from the table
        function collectData() {
            const rows = document.querySelectorAll('#tableBody tr');
            const data = [];

            rows.forEach(row => {
                data.push(getRowData(row));
            });

            return data;
        }

        // Load data into the table
        function loadData(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            data.forEach(rowData => {
                addRow(rowData);
            });
        }

        // Save project as PDF with one shot per page
        async function saveAsPNG() {
            const rows = document.querySelectorAll('#tableBody tr');

            if (rows.length === 0) {
                alert('No shots to export!');
                return;
            }

            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            let isFirstPage = true;

            for (const row of rows) {
                if (!isFirstPage) {
                    pdf.addPage();
                }
                isFirstPage = false;

                // Create a temporary container for the shot card
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.left = '-9999px';
                container.style.top = '0';
                container.style.backgroundColor = '#000';
                container.style.color = '#fff';
                container.style.padding = '30px';
                container.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif';
                container.style.width = '800px';
                document.body.appendChild(container);

                // Get row data
                const rowData = getRowData(row);

                // Create shot card HTML (same format as individual export)
                container.innerHTML = `
                    <div style="background-color: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 25px;">
                        <h1 style="margin: 0 0 25px 0; font-size: 32px; border-bottom: 2px solid #1E90FF; padding-bottom: 15px;">
                            Shot ${rowData.shotNumber}
                        </h1>

                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">STATUS</h3>
                            <p style="margin: 0; font-size: 16px; text-transform: capitalize;">${rowData.status.replace('-', ' ')}</p>
                        </div>

                        ${rowData.notes ? `
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">NOTES</h3>
                                <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.notes}</p>
                            </div>
                        ` : ''}

                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">VISUAL ACTION</h3>
                            <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.visualAction || 'N/A'}</p>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">AUDIO</h3>
                            <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.audio || 'N/A'}</p>
                        </div>

                        <div style="margin-bottom: ${rowData.images.length > 0 ? '20px' : '0'};">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">SHOT SPECS</h3>
                            <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.shotSpecs || 'N/A'}</p>
                        </div>

                        ${rowData.images.length > 0 ? `
                            <div>
                                <h3 style="margin: 0 0 15px 0; color: #1E90FF; font-size: 16px;">REFERENCE MEDIA</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                                    ${rowData.images.map(img => `
                                        <div style="background-color: #000; border: 1px solid #333; border-radius: 6px; padding: 10px;">
                                            ${img.type === 'video'
                                                ? `<div style="width: 100%; height: auto; border-radius: 4px; display: block; margin-bottom: 10px; background: #1a1a1a; padding: 40px 0; text-align: center; color: #1E90FF; font-size: 14px;">📹 VIDEO<br><span style="font-size: 11px; color: #999;">${img.src.split('/').pop()}</span></div>`
                                                : `<img src="${img.src}" style="width: 100%; height: auto; border-radius: 4px; display: block; margin-bottom: 10px;">`
                                            }
                                            ${img.caption ? `<p style="margin: 0; font-size: 13px; color: #ccc; text-align: center;">${img.caption}</p>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Use html2canvas to convert to canvas
                const canvas = await html2canvas(container, {
                    backgroundColor: '#000',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                // Add canvas as image to PDF
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                // Clean up
                document.body.removeChild(container);
            }

            // Download the PDF with project name if available
            const projectName = localStorage.getItem('project_name');
            const fileName = projectName ? `${projectName.replace(/\s+/g, '_')}_${Date.now()}.pdf` : `storyboard_${Date.now()}.pdf`;
            pdf.save(fileName);
        }

        // Export single shot as PNG
        async function exportSingleShot(row) {
            // Create a temporary container for the shot card
            const container = document.createElement('div');
            container.style.position = 'fixed';
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.backgroundColor = '#000';
            container.style.color = '#fff';
            container.style.padding = '30px';
            container.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif';
            container.style.width = '800px';
            document.body.appendChild(container);

            // Get row data
            const rowData = getRowData(row);

            // Create shot card HTML
            container.innerHTML = `
                <div style="background-color: #1a1a1a; border: 2px solid #333; border-radius: 8px; padding: 25px;">
                    <h1 style="margin: 0 0 25px 0; font-size: 32px; border-bottom: 2px solid #1E90FF; padding-bottom: 15px;">
                        Shot ${rowData.shotNumber}
                    </h1>

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">STATUS</h3>
                        <p style="margin: 0; font-size: 16px; text-transform: capitalize;">${rowData.status.replace('-', ' ')}</p>
                    </div>

                    ${rowData.notes ? `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">NOTES</h3>
                            <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.notes}</p>
                        </div>
                    ` : ''}

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">VISUAL ACTION</h3>
                        <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.visualAction || 'N/A'}</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">AUDIO</h3>
                        <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.audio || 'N/A'}</p>
                    </div>

                    <div style="margin-bottom: ${rowData.images.length > 0 ? '20px' : '0'};">
                        <h3 style="margin: 0 0 8px 0; color: #1E90FF; font-size: 16px;">SHOT SPECS</h3>
                        <p style="margin: 0; font-size: 16px; white-space: pre-wrap;">${rowData.shotSpecs || 'N/A'}</p>
                    </div>

                    ${rowData.images.length > 0 ? `
                        <div>
                            <h3 style="margin: 0 0 15px 0; color: #1E90FF; font-size: 16px;">REFERENCE MEDIA</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px;">
                                ${rowData.images.map(img => `
                                    <div style="background-color: #000; border: 1px solid #333; border-radius: 6px; padding: 10px;">
                                        ${img.type === 'video'
                                            ? `<div style="width: 100%; height: auto; border-radius: 4px; display: block; margin-bottom: 10px; background: #1a1a1a; padding: 40px 0; text-align: center; color: #1E90FF; font-size: 14px;">📹 VIDEO<br><span style="font-size: 11px; color: #999;">${img.src.split('/').pop()}</span></div>`
                                            : `<img src="${img.src}" style="width: 100%; height: auto; border-radius: 4px; display: block; margin-bottom: 10px;">`
                                        }
                                        ${img.caption ? `<p style="margin: 0; font-size: 13px; color: #ccc; text-align: center;">${img.caption}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Use html2canvas to convert to PNG
            const canvas = await html2canvas(container, {
                backgroundColor: '#000',
                scale: 2,
                logging: false,
                useCORS: true,
                allowTaint: true
            });

            // Download the image
            const link = document.createElement('a');
            link.download = `shot_${rowData.shotNumber}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();

            // Clean up
            document.body.removeChild(container);
        }

        // Save as JSON
        function saveAsJSON() {
            const data = collectData();

            // Include project name and API key in the export
            const projectName = localStorage.getItem('project_name');
            const apiKey = localStorage.getItem('openai_api_key');
            const exportData = {
                projectName: projectName || null,
                shots: data,
                apiKey: apiKey || null
            };

            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            const fileName = projectName ? `${projectName.replace(/\s+/g, '_')}_${Date.now()}.json` : `storyboard_${Date.now()}.json`;
            link.download = fileName;
            link.href = URL.createObjectURL(blob);
            link.click();
        }

        // Load from file
        function loadFromFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const parsedData = JSON.parse(e.target.result);

                    // Check if this is the new format with projectName/apiKey
                    if (parsedData.shots && Array.isArray(parsedData.shots)) {
                        // New format: { projectName: "...", shots: [...], apiKey: "..." }
                        loadData(parsedData.shots);

                        // Restore project name if present
                        if (parsedData.projectName) {
                            localStorage.setItem('project_name', parsedData.projectName);
                            updateProjectName(parsedData.projectName);
                            console.log('Project name restored from file');
                        }

                        // Restore API key if present
                        if (parsedData.apiKey) {
                            localStorage.setItem('openai_api_key', parsedData.apiKey);
                            console.log('API key restored from file');
                        }
                    } else {
                        // Old format: just array of shots
                        loadData(parsedData);
                    }

                    updateShotCounter();
                    triggerAutoSave();
                } catch (error) {
                    alert('Error loading file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Event listeners
        document.getElementById('addShotBtn').addEventListener('click', () => {
            const newRow = addRow();
            updateShotCounter();
            triggerAutoSave();

            // Scroll to new row on mobile
            setTimeout(() => {
                newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        });

        // Save button - saves current work as a project (prompts for name)
        document.getElementById('saveProjectBtn').addEventListener('click', async () => {
            const currentName = localStorage.getItem('project_name') || '';
            const defaultName = currentName || `Project ${new Date().toLocaleDateString()}`;

            const projectName = prompt('Enter project name:', defaultName);
            if (!projectName) return;

            // Set as current project
            const projectId = projectName.replace(/[^a-zA-Z0-9-_]/g, '_').toLowerCase();
            currentProjectId = projectId;
            localStorage.setItem('currentProjectId', projectId);
            localStorage.setItem('project_name', projectName);
            updateProjectName(projectName);

            // Save current data to cloud
            const data = collectData();
            try {
                await saveProjectToCloud(projectName, data);
                await loadProjectList();

                // Select in dropdown
                const selector = document.getElementById('projectSelector');
                selector.value = projectId;

                alert('Project saved successfully!');
            } catch (error) {
                alert('Failed to save project: ' + error.message);
            }

            updateShotCounter();
        });

        // Project selector change
        document.getElementById('projectSelector').addEventListener('change', async (e) => {
            const projectId = e.target.value;
            if (!projectId) return;

            if (confirm('Load this project? Any unsaved changes will be lost.')) {
                await loadProjectFromCloud(projectId);
            } else {
                // Reset selector to current project
                e.target.value = currentProjectId || '';
            }
        });

        document.getElementById('savePngBtn').addEventListener('click', saveAsPNG);

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadFromFile(file);
            }
        });

        // Fullscreen overlay event listeners
        document.getElementById('fullscreenClose').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeFullscreen();
        });

        document.getElementById('fullscreenOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'fullscreenOverlay') {
                closeFullscreen();
            }
        });

        // Voice input using Web Speech API
        let recognition = null;

        function startVoiceInput(textarea, micBtn) {
            // Check if browser supports speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert('Voice input is not supported in your browser. Please use Chrome, Safari, or Edge.');
                return;
            }

            // If already recording, stop
            if (micBtn.classList.contains('recording')) {
                if (recognition) {
                    recognition.stop();
                }
                return;
            }

            // Create new recognition instance
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            let finalTranscript = textarea.value;

            recognition.onstart = () => {
                micBtn.classList.add('recording');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += (finalTranscript ? ' ' : '') + transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                textarea.value = finalTranscript + (interimTranscript ? ' ' + interimTranscript : '');
                triggerAutoSave();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                micBtn.classList.remove('recording');

                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access in your browser settings.');
                }
            };

            recognition.onend = () => {
                micBtn.classList.remove('recording');
                textarea.value = finalTranscript;
                triggerAutoSave();
            };

            // Start recognition
            recognition.start();
        }

        // Enhance text with AI using OpenAI API
        async function enhanceTextWithAI(textarea) {
            const text = textarea.value.trim();

            if (!text) {
                alert('Please enter some text first');
                return;
            }

            const apiKey = localStorage.getItem('openai_api_key');

            if (!apiKey) {
                alert('Please set your OpenAI API key in Settings first');
                openSettings();
                return;
            }

            // Show loading state
            const originalText = text;
            textarea.value = 'Enhancing...';
            textarea.disabled = true;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant that cleans up and clarifies text for film storyboards. Remove filler words, organize thoughts, and make the text concise and clear while keeping the exact same meaning and intent. Keep it brief and professional. Do not add any information that was not in the original text.'
                            },
                            {
                                role: 'user',
                                content: text
                            }
                        ],
                        temperature: 0.3,
                        max_tokens: 200
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const enhancedText = data.choices[0].message.content.trim();

                textarea.value = enhancedText;
                textarea.disabled = false;
                triggerAutoSave();

            } catch (error) {
                console.error('Error enhancing text:', error);
                textarea.value = originalText;
                textarea.disabled = false;
                alert('Error enhancing text. Please check your API key and try again.');
            }
        }

        // Settings modal functions
        async function openSettings() {
            const modal = document.getElementById('settingsModal');
            const projectNameInput = document.getElementById('projectNameInput');
            const apiKeyInput = document.getElementById('apiKeyInput');

            // Load existing project name from localStorage
            const savedProjectName = localStorage.getItem('project_name');
            if (savedProjectName) {
                projectNameInput.value = savedProjectName;
            }

            // Load existing API key from localStorage
            const savedKey = localStorage.getItem('openai_api_key');
            if (savedKey) {
                apiKeyInput.value = savedKey;
            }

            // Populate delete project dropdown
            await populateDeleteDropdown();

            modal.classList.add('active');
        }

        // Populate delete project dropdown
        async function populateDeleteDropdown() {
            try {
                const listUrl = `${R2_CONFIG.publicUrl}/projects/index.json`;
                const response = await fetch(listUrl);

                const deleteSelect = document.getElementById('deleteProjectSelect');
                deleteSelect.innerHTML = '<option value="">Select a project to delete...</option>';

                if (!response.ok) {
                    return;
                }

                const projectList = await response.json();

                for (const [id, info] of Object.entries(projectList)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = info.name;
                    option.dataset.projectName = info.name;
                    deleteSelect.appendChild(option);
                }

            } catch (error) {
                console.error('Error loading projects for deletion:', error);
            }
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('active');
        }

        function saveSettings() {
            const projectNameInput = document.getElementById('projectNameInput');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const projectName = projectNameInput.value.trim();
            const apiKey = apiKeyInput.value.trim();

            // Save project name
            if (projectName) {
                localStorage.setItem('project_name', projectName);
                updateProjectName(projectName);
            } else {
                localStorage.removeItem('project_name');
                updateProjectName('Storyboard');
            }

            // Save API key
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
            }

            alert('Settings saved successfully!');
            closeSettings();
        }

        function clearApiKey() {
            if (confirm('Are you sure you want to clear your API key?')) {
                localStorage.removeItem('openai_api_key');
                document.getElementById('apiKeyInput').value = '';
                alert('API key cleared');
            }
        }

        function updateProjectName(name) {
            // Update page title
            document.title = name || 'Storyboard';
        }

        // Delete project with confirmation
        async function deleteProject() {
            const deleteSelect = document.getElementById('deleteProjectSelect');
            const projectId = deleteSelect.value;

            if (!projectId) {
                alert('Please select a project to delete');
                return;
            }

            const selectedOption = deleteSelect.options[deleteSelect.selectedIndex];
            const projectName = selectedOption.dataset.projectName;

            // First confirmation
            if (!confirm(`Are you sure you want to delete "${projectName}"?\n\nThis will permanently delete:\n- The project data\n- All associated videos\n\nThis action cannot be undone.`)) {
                return;
            }

            // Second confirmation - type project name
            const confirmation = prompt(`To confirm deletion, please type the project name exactly:\n\n${projectName}`);

            if (confirmation !== projectName) {
                alert('Project name did not match. Deletion cancelled.');
                return;
            }

            try {
                // Delete project file from R2
                const projectFileName = `projects/${projectId}.json`;
                await deleteFromR2(projectFileName);

                // Delete videos folder (note: R2 doesn't have folder deletion, so we note this)
                // Videos will remain but won't be referenced
                console.log(`Videos in videos/${projectId}/ will remain in storage`);

                // Update project list
                await removeFromProjectList(projectId);

                // Refresh project list in dropdown and delete dropdown
                await loadProjectList();
                await populateDeleteDropdown();

                // If we just deleted the current project, clear it
                if (currentProjectId === projectId) {
                    currentProjectId = null;
                    localStorage.removeItem('currentProjectId');
                    localStorage.removeItem('project_name');
                    updateProjectName('No Project');

                    // Reset selector
                    const selector = document.getElementById('projectSelector');
                    selector.value = '';
                }

                alert(`Project "${projectName}" has been deleted successfully.`);

            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Failed to delete project: ' + error.message);
            }
        }

        // Delete file from R2
        async function deleteFromR2(fileName) {
            const url = `${R2_CONFIG.endpoint}/${R2_CONFIG.bucketName}/${fileName}`;

            const date = new Date();
            const amzDate = date.toISOString().replace(/[:-]|\.\d{3}/g, '');
            const dateStamp = amzDate.substring(0, 8);

            // Create canonical request for DELETE
            const canonicalRequest = [
                'DELETE',
                `/${R2_CONFIG.bucketName}/${fileName}`,
                '',
                `host:${R2_CONFIG.accountId}.r2.cloudflarestorage.com`,
                `x-amz-date:${amzDate}`,
                '',
                'host;x-amz-date',
                'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855' // empty payload hash
            ].join('\n');

            const canonicalRequestHash = await sha256Hex(canonicalRequest);

            // Create string to sign
            const credentialScope = `${dateStamp}/auto/s3/aws4_request`;
            const stringToSign = [
                'AWS4-HMAC-SHA256',
                amzDate,
                credentialScope,
                canonicalRequestHash
            ].join('\n');

            // Calculate signature
            const signature = await calculateSignature(R2_CONFIG.secretAccessKey, dateStamp, stringToSign);

            // Create authorization header
            const authorization = `AWS4-HMAC-SHA256 Credential=${R2_CONFIG.accessKeyId}/${credentialScope}, SignedHeaders=host;x-amz-date, Signature=${signature}`;

            // Make the request
            const response = await fetch(url, {
                method: 'DELETE',
                headers: {
                    'Host': `${R2_CONFIG.accountId}.r2.cloudflarestorage.com`,
                    'x-amz-date': amzDate,
                    'Authorization': authorization
                }
            });

            if (!response.ok && response.status !== 404) {
                throw new Error(`Delete failed: ${response.status}`);
            }
        }

        // Remove project from index
        async function removeFromProjectList(projectId) {
            try {
                const listUrl = `${R2_CONFIG.publicUrl}/projects/index.json`;
                let projectList = {};

                try {
                    const response = await fetch(listUrl);
                    if (response.ok) {
                        projectList = await response.json();
                    }
                } catch (e) {
                    // No index exists
                    return;
                }

                // Remove project from list
                delete projectList[projectId];

                // Save updated list
                await uploadToR2('projects/index.json', JSON.stringify(projectList), 'application/json');

            } catch (error) {
                console.error('Error removing from project list:', error);
            }
        }

        // Settings event listeners
        document.getElementById('settingsBtn').addEventListener('click', openSettings);
        document.getElementById('saveSettings').addEventListener('click', saveSettings);
        document.getElementById('clearApiKey').addEventListener('click', clearApiKey);
        document.getElementById('cancelSettings').addEventListener('click', closeSettings);
        document.getElementById('deleteProjectBtn').addEventListener('click', deleteProject);

        // Modal action button event listeners
        document.getElementById('modalSavePdf').addEventListener('click', () => {
            saveAsPNG();
            closeSettings();
        });

        document.getElementById('modalDownloadBackup').addEventListener('click', () => {
            saveAsJSON();
            closeSettings();
        });

        document.getElementById('modalLoadFile').addEventListener('click', () => {
            document.getElementById('fileInput').click();
            closeSettings();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadFromFile(file);
            }
        });

        // Close settings modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') {
                closeSettings();
            }
        });

        // Prevent closing when clicking on the image itself
        document.getElementById('fullscreenImage').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Initialize
        init();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }
    </script>
</body>
</html>
